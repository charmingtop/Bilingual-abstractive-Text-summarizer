"""
Interactive abstractive summarizer using BART-Large (facebook/bart-large-cnn).

Features:
- Single summary
- Paragraph-wise summary
- Long document summary
- Quick / detailed presets
- Structured summary: choose number of paragraphs and lines per paragraph
- NEW: Input/Output language options (English / Hindi) via Google Translate
"""

import os
import sys
import time
if hasattr(sys.stdout, "reconfigure"):
    try:
        sys.stdout.reconfigure(encoding="utf-8")
        sys.stderr.reconfigure(encoding="utf-8")
    except Exception:
        pass
# Allow importing summarizer.py from same folder
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from summarizer import BartLargeAbstractiveSummarizer
from nltk.tokenize import sent_tokenize, word_tokenize

# NEW: Google Translate wrapper
try:
    from googletrans import Translator
except ImportError:
    Translator = None


class InteractiveSummarizer:
    def __init__(self):
        self.summarizer = None
        self.translator = Translator() if Translator is not None else None
        self.clear_screen()

    # ----------------- Utility UI methods -----------------

    def clear_screen(self):
        os.system("cls" if os.name == "nt" else "clear")

    def print_header(self):
        print("=" * 70)
        print("ABSTRACTIVE TEXT SUMMARIZER (BART-Large)".center(70))
        print("=" * 70)
        print("Model: facebook/bart-large-cnn")
        print("This tool creates rephrased, abstractive summaries.")
        print("Supports input/output in English & Hindi via Google Translate.")
        print("=" * 70)
        print()

    def show_main_menu(self):
        print("MAIN MENU")
        print("-" * 70)
        print("1. Enter text manually")
        print("2. Load text from file")
        print("3. Help / instructions")
        print("4. Exit")
        print("-" * 70)

    # ----------------- Input methods -----------------

    def get_text_manually(self):
        print("\nEnter/paste your text below.")
        print("Press Enter twice on an empty line to finish.\n")

        lines = []
        empty_count = 0

        while True:
            try:
                line = input()
            except EOFError:
                break

            if line.strip() == "":
                empty_count += 1
                if empty_count >= 2:
                    break
                lines.append("")
            else:
                empty_count = 0
                lines.append(line)

        text = "\n".join(lines).strip()
        return text if text else None

    def get_text_from_file(self):
        print("\nLOAD TEXT FROM FILE")
        print("-" * 70)
        path = input("Enter file path (default: input.txt): ").strip()
        if not path:
            path = "input.txt"

        if not os.path.exists(path):
            print(f"\nError: file '{path}' not found.")
            return None

        try:
            with open(path, "r", encoding="utf-8") as f:
                text = f.read()
        except Exception as e:
            print(f"\nError reading file: {e}")
            return None

        print(f"\nLoaded file: {path}")
        print(f"Characters: {len(text):,}  |  Words: {len(text.split()):,}")
        return text

    # ----------------- Language selection + translation -----------------

    def choose_languages(self):
        """
        Let the user choose input and output language.
        Input: English / Hindi / Auto-detect
        Output: English / Hindi
        Returns: (input_lang, output_lang)
          input_lang ∊ {"en", "hi", "auto"}
          output_lang ∊ {"en", "hi"}
        """
        print("\nLANGUAGE OPTIONS")
        print("-" * 70)

        if self.translator is None:
            print("WARNING: googletrans not installed. Language will be treated as English only.")
            print("Install with: pip install googletrans==4.0.0rc1\n")
            return "en", "en"

        # Input language
        print("Input language:")
        print("  1. English")
        print("  2. Hindi")
        print("  3. Auto-detect")
        while True:
            choice_in = input("Choose input language (1-3) [default: 3]: ").strip()
            if choice_in == "" or choice_in == "3":
                input_lang = "auto"
                break
            elif choice_in == "1":
                input_lang = "en"
                break
            elif choice_in == "2":
                input_lang = "hi"
                break
            else:
                print("Invalid choice. Please enter 1, 2, or 3.")

        # Output language
        print("\nOutput summary language:")
        print("  1. English")
        print("  2. Hindi")
        while True:
            choice_out = input("Choose output language (1-2) [default: 1]: ").strip()
            if choice_out == "" or choice_out == "1":
                output_lang = "en"
                break
            elif choice_out == "2":
                output_lang = "hi"
                break
            else:
                print("Invalid choice. Please enter 1 or 2.")

        return input_lang, output_lang

    def translate_text(self, text, src=None, dest="en"):
        """Translate text using googletrans. If translation fails, returns original text."""
        if self.translator is None:
            return text

        if not text.strip():
            return text

        try:
            # googletrans works better on shorter chunks; here we just call once
            result = self.translator.translate(text, src=src, dest=dest)
            return result.text
        except Exception as e:
            print(f"\n[Translation warning] {e}")
            return text

    def detect_language(self, text):
        """Detect language using googletrans. Returns 'en', 'hi', or 'en' fallback."""
        if self.translator is None:
            return "en"

        snippet = text[:5000]  # limit for detection
        try:
            detected = self.translator.detect(snippet)
            lang = detected.lang.lower()
            if lang.startswith("hi"):
                return "hi"
            elif lang.startswith("en"):
                return "en"
            else:
                # Unknown / other → default to English
                return "en"
        except Exception as e:
            print(f"\n[Language detect warning] {e}")
            return "en"

    # ----------------- Mode selection -----------------

    def get_summarization_mode(self):
        print("\nSUMMARIZATION MODES")
        print("-" * 70)
        print("1. Single summary (recommended)")
        print("2. Paragraph-by-paragraph summary")
        print("3. Long document mode")
        print("4. Quick summary (shorter)")
        print("5. Detailed summary (longer)")
        print("6. Structured summary (paragraphs + lines)")
        print("-" * 70)

        while True:
            choice = input("Choose mode (1-6): ").strip()

            if choice == "1":
                return {"mode": "single", "max_len": 150, "min_len": 40}
            elif choice == "2":
                return {"mode": "paragraphs", "max_len": 80, "min_len": 20}
            elif choice == "3":
                return {"mode": "long", "max_len": 180, "min_len": 60}
            elif choice == "4":
                return {"mode": "quick", "max_len": 80, "min_len": 30}
            elif choice == "5":
                return {"mode": "detailed", "max_len": 220, "min_len": 70}
            elif choice == "6":
                return {"mode": "structured"}
            else:
                print("Invalid choice. Please enter a number from 1 to 6.")

    def get_structured_params(self):
        """Ask user for number of paragraphs and lines per paragraph."""
        print("\nSTRUCTURED SUMMARY SETTINGS")
        print("-" * 70)

        while True:
            try:
                num_paras = int(input("Number of paragraphs (1-10): ").strip())
                if 1 <= num_paras <= 10:
                    break
                print("Please enter a number between 1 and 10.")
            except ValueError:
                print("Invalid input. Please enter a number.")

        while True:
            try:
                lines_per_para = int(
                    input("Approx. lines per paragraph (1-6): ").strip()
                )
                if 1 <= lines_per_para <= 6:
                    break
                print("Please enter a number between 1 and 6.")
            except ValueError:
                print("Invalid input. Please enter a number.")

        return num_paras, lines_per_para

    # ----------------- Summarization logic -----------------

    def ensure_model_loaded(self):
        if self.summarizer is None:
            print("\nLoading BART-Large model. This may take some time...")
            self.summarizer = BartLargeAbstractiveSummarizer()
            print("Model loaded successfully.\n")

    def summarize_text(self, text, mode_info):
        """Run summarization according to selected mode."""
        self.ensure_model_loaded()
        start_time = time.time()

        mode = mode_info["mode"]

        if mode == "structured":
            num_paras, lines_per_para = self.get_structured_params()
            summary = self.summarizer.summarize_structured(
                text,
                num_paragraphs=num_paras,
                lines_per_paragraph=lines_per_para,
            )

        elif mode == "paragraphs":
            summary = self.summarizer.summarize_paragraphs(text)

        elif mode == "long":
            summary = self.summarizer.summarize_long_document(text)

        else:
            summary = self.summarizer.summarize(
                text,
                max_length=mode_info["max_len"],
                min_length=mode_info["min_len"],
            )

        elapsed = time.time() - start_time
        return summary, elapsed

    # ----------------- Display results -----------------

    def display_results(
        self,
        original_text,
        summary,
        elapsed_seconds,
        original_lang="en",
        output_lang="en",
    ):
        self.clear_screen()
        self.print_header()

        # Stats (based on displayed text)
        orig_words = len(word_tokenize(original_text)) if original_text.strip() else 0
        sum_words = len(word_tokenize(summary)) if summary.strip() else 0
        orig_sents = len(sent_tokenize(original_text)) if original_text.strip() else 0
        sum_sents = len(sent_tokenize(summary)) if summary.strip() else 0
        reduction = ((orig_words - sum_words) / orig_words * 100) if orig_words else 0

        lang_map = {"en": "English", "hi": "Hindi"}

        print("LANGUAGES")
        print("-" * 70)
        print(f"Original text language: {lang_map.get(original_lang, original_lang)}")
        print(f"Summary language:       {lang_map.get(output_lang, output_lang)}")
        print("-" * 70)
        print()

        print("SUMMARY (FULL)")
        print("-" * 70)
        print(summary)
        print("-" * 70)
        print(f"Time taken: {elapsed_seconds:.2f} seconds\n")

        print("STATISTICS (approximate)")
        print("-" * 70)
        print(f"Original: {orig_words} words, {orig_sents} sentences")
        print(f"Summary:  {sum_words} words, {sum_sents} sentences")
        print(f"Reduction: {reduction:.1f}%")
        print("-" * 70)

        print("\nFULL ORIGINAL TEXT")
        print("-" * 70)
        print(original_text)
        print("-" * 70)

    # ----------------- Help text -----------------

    def show_help(self):
        self.clear_screen()
        self.print_header()

        print("HELP / INSTRUCTIONS")
        print("-" * 70)
        print("This tool uses BART-Large CNN to generate abstractive summaries.")
        print("Now supports English/Hindi input and output using Google Translate.")
        print("Pipeline when using Hindi:")
        print("  Hindi → (translate) → English → (summarize) → English")
        print("    → (optional translate) → Hindi summary")
        print("Works best with 100–1200 words.")
        print("-" * 70)

        input("\nPress Enter to return to menu...")

    # ----------------- Main loop -----------------

    def run(self):
        self.clear_screen()
        self.print_header()
        input("Press Enter to start...")

        while True:
            self.clear_screen()
            self.print_header()
            self.show_main_menu()

            choice = input("\nEnter choice (1-4): ").strip()

            if choice == "1":
                text = self.get_text_manually()
            elif choice == "2":
                text = self.get_text_from_file()
            elif choice == "3":
                self.show_help()
                continue
            elif choice == "4":
                print("\nGoodbye!\n")
                break
            else:
                print("Invalid choice.")
                time.sleep(1)
                continue

            if not text:
                print("No text entered.")
                time.sleep(1)
                continue

            # Language selection + translation
            input_lang, output_lang = self.choose_languages()

            # Determine actual original language (for display)
            if input_lang == "auto":
                original_lang = self.detect_language(text)
            else:
                original_lang = input_lang

            # For BART: always summarize in English
            if original_lang == "hi":
                text_for_summary = self.translate_text(text, src="hi", dest="en")
            else:
                # Treat anything non-Hindi as English for summarizer
                text_for_summary = text

            mode_info = self.get_summarization_mode()
            summary_en, elapsed = self.summarize_text(text_for_summary, mode_info)

            # Convert summary to desired output language
            if output_lang == "hi":
                final_summary = self.translate_text(summary_en, src="en", dest="hi")
            else:
                final_summary = summary_en

            self.display_results(
                original_text=text,
                summary=final_summary,
                elapsed_seconds=elapsed,
                original_lang=original_lang,
                output_lang=output_lang,
            )

            again = input("\nSummarize another? (y/n): ").strip().lower()
            if again != "y":
                print("\nGoodbye!\n")
                break


# ----------------- Dependency check -----------------

def check_dependencies():
    required = ["torch", "transformers", "nltk"]
    missing = []

    for pkg in required:
        try:
            __import__(pkg)
        except:
            missing.append(pkg)

    # googletrans is optional but recommended for Hindi support
    try:
        __import__("googletrans")
    except:
        print("Note: 'googletrans' not found. Hindi translation will be disabled.")
        print("Install it with: pip install googletrans==4.0.0rc1")

    if missing:
        print("Missing packages:", ", ".join(missing))
        print("Install using: pip install torch transformers nltk")
        return False

    return True


def main():
    print("Checking dependencies...")
    if not check_dependencies():
        input("Press Enter to exit...")
        return

    app = InteractiveSummarizer()
    app.run()


if __name__ == "__main__":
    main()
    
    